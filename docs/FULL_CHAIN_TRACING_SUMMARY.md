# å…¨é“¾è·¯æ—¥å¿—è·Ÿè¸ªå®æ–½æ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ ¸å¿ƒä¸Šä¸‹æ–‡ç®¡ç†æ¨¡å—

**æ–‡ä»¶ï¼š** `backend/src/morado/common/logger/context.py`

å®ç°äº†åŸºäº `contextvars` çš„ä¸Šä¸‹æ–‡ç®¡ç†ï¼š

```python
# æ ¸å¿ƒå‡½æ•°
- set_request_id(request_id: str)          # è®¾ç½® Request ID
- get_request_id() -> str | None           # è·å– Request ID
- set_context_data(key, value)             # è®¾ç½®ä¸Šä¸‹æ–‡æ•°æ®
- get_context_data(key=None)               # è·å–ä¸Šä¸‹æ–‡æ•°æ®
- get_log_context() -> dict                # è·å–å®Œæ•´æ—¥å¿—ä¸Šä¸‹æ–‡
- clear_context()                          # æ¸…é™¤ä¸Šä¸‹æ–‡
```

**ç‰¹æ€§ï¼š**
- âœ… ä½¿ç”¨ Python `contextvars` å®ç°çº¿ç¨‹å®‰å…¨å’Œå¼‚æ­¥å®‰å…¨
- âœ… è‡ªåŠ¨åœ¨æ•´ä¸ªè°ƒç”¨é“¾ä¸­ä¼ æ’­
- âœ… æ— éœ€æ‰‹åŠ¨ä¼ é€’å‚æ•°

### 2. å¢å¼ºçš„æ—¥å¿—ä¸­é—´ä»¶

**æ–‡ä»¶ï¼š** `backend/src/morado/middleware/logging.py`

ä¸­é—´ä»¶è‡ªåŠ¨å¤„ç†ï¼š
- âœ… ç”Ÿæˆæˆ–æå– Request ID
- âœ… è®¾ç½®åˆ°ä¸Šä¸‹æ–‡å˜é‡ä¸­
- âœ… è®°å½•è¯·æ±‚å¼€å§‹å’Œç»“æŸ
- âœ… åœ¨å“åº”å¤´ä¸­è¿”å› Request ID
- âœ… è¯·æ±‚ç»“æŸåæ¸…é™¤ä¸Šä¸‹æ–‡

**å…³é”®ä»£ç ï¼š**
```python
# è®¾ç½® Request ID åˆ°ä¸Šä¸‹æ–‡
set_request_id(request_id)

# è®¾ç½®åŸºç¡€ä¸Šä¸‹æ–‡æ•°æ®
set_context_data("method", method)
set_context_data("path", path)
set_context_data("client_ip", client_ip)

# è®°å½•æ—¥å¿— - è‡ªåŠ¨åŒ…å«æ‰€æœ‰ä¸Šä¸‹æ–‡
logger.info("Request started", extra=get_log_context())
```

### 3. æ›´æ–°çš„æœåŠ¡å±‚

**æ–‡ä»¶ï¼š** `backend/src/morado/services/api_component.py`

æœåŠ¡å±‚ä½¿ç”¨ä¸Šä¸‹æ–‡ï¼š
- âœ… å¯¼å…¥ `get_log_context`
- âœ… åœ¨æ—¥å¿—ä¸­ä½¿ç”¨ `**get_log_context()`
- âœ… æ·»åŠ æœåŠ¡å±‚ç‰¹å®šçš„ä¸Šä¸‹æ–‡æ•°æ®

**ç¤ºä¾‹ï¼š**
```python
logger.info(
    "Creating header component",
    extra={
        **get_log_context(),  # è‡ªåŠ¨åŒ…å« request_id ç­‰
        "name": name,
        "scope": scope.value,
    },
)
```

### 4. æ¼”ç¤ºè„šæœ¬

**æ–‡ä»¶ï¼š** `backend/scripts/demo_request_tracing.py`

å®Œæ•´æ¼”ç¤ºï¼š
- âœ… å•ä¸ªè¯·æ±‚çš„å®Œæ•´è·Ÿè¸ªï¼ˆHTTP â†’ Service â†’ Repository â†’ Databaseï¼‰
- âœ… å¤šä¸ªå¹¶å‘è¯·æ±‚çš„ç‹¬ç«‹è·Ÿè¸ª
- âœ… é”™è¯¯æƒ…å†µä¸‹çš„ä¸Šä¸‹æ–‡ä¿ç•™

**è¿è¡Œç»“æœï¼š**
```
âœ“ æ‰€æœ‰æ—¥å¿—åŒ…å«ç›¸åŒçš„ request_id
âœ“ ä¸Šä¸‹æ–‡æ•°æ®åœ¨æ•´ä¸ªè°ƒç”¨é“¾ä¸­ä¿æŒ
âœ“ æ¯ä¸ªè¯·æ±‚æœ‰ç‹¬ç«‹çš„ request_id
âœ“ é”™è¯¯æ—¥å¿—åŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡
```

### 5. å®Œæ•´æ–‡æ¡£

åˆ›å»ºäº†è¯¦ç»†çš„æ–‡æ¡£ï¼š
- âœ… `docs/REQUEST_TRACING_GUIDE.md` - å®Œæ•´çš„ä½¿ç”¨æŒ‡å—
- âœ… `docs/LOGGING_GUIDE.md` - æ—¥å¿—ç³»ç»ŸæŒ‡å—
- âœ… `docs/LOGGING_QUICK_REFERENCE.md` - å¿«é€Ÿå‚è€ƒ
- âœ… `docs/LOGGING_IMPLEMENTATION_SUMMARY.md` - å®æ–½æ€»ç»“

## ğŸ¯ å®ç°æ•ˆæœ

### æ—¥å¿—è¾“å‡ºç¤ºä¾‹

**å•ä¸ªè¯·æ±‚çš„å®Œæ•´è·Ÿè¸ªï¼š**

```
[info] Request started
  request_id: REQ-demo-12345
  method: POST
  path: /v1/headers
  client_ip: 192.168.1.100

[info] Creating header component
  request_id: REQ-demo-12345  â† ç›¸åŒçš„ ID
  method: POST
  path: /v1/headers
  service: HeaderService
  operation: create_header

[debug] Creating header in database
  request_id: REQ-demo-12345  â† ç›¸åŒçš„ ID
  method: POST
  path: /v1/headers
  service: HeaderService
  repository: HeaderRepository

[debug] Executing SQL INSERT
  request_id: REQ-demo-12345  â† ç›¸åŒçš„ ID
  method: POST
  path: /v1/headers
  query: INSERT INTO headers...

[info] Request completed
  request_id: REQ-demo-12345  â† ç›¸åŒçš„ ID
  status_code: 200
  duration: 0.045
```

### å…³é”®ç‰¹æ€§

1. **è‡ªåŠ¨ä¼ æ’­**
   - Request ID è‡ªåŠ¨åœ¨æ‰€æœ‰å±‚çº§ä¸­å¯ç”¨
   - æ— éœ€æ‰‹åŠ¨ä¼ é€’å‚æ•°
   - åŸºäº Python `contextvars` æœºåˆ¶

2. **å®Œæ•´è¦†ç›–**
   - HTTP å±‚ï¼ˆMiddlewareï¼‰
   - æœåŠ¡å±‚ï¼ˆServicesï¼‰
   - ä»“å‚¨å±‚ï¼ˆRepositoriesï¼‰
   - æ•°æ®åº“å±‚ï¼ˆDatabaseï¼‰

3. **æ˜“äºä½¿ç”¨**
   ```python
   # åªéœ€åœ¨æ—¥å¿—ä¸­ä½¿ç”¨ get_log_context()
   logger.info("Message", extra=get_log_context())
   ```

4. **é«˜æ€§èƒ½**
   - åŸºäº Python å†…ç½®æœºåˆ¶
   - çº¿ç¨‹å®‰å…¨å’Œå¼‚æ­¥å®‰å…¨
   - æœ€å°åŒ–æ€§èƒ½å¼€é”€

## ğŸ“Š æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HTTP Request                         â”‚
â”‚                  (X-Request-ID Header)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Logging Middleware                         â”‚
â”‚  â€¢ Generate/Extract Request ID                          â”‚
â”‚  â€¢ set_request_id(request_id)                          â”‚
â”‚  â€¢ set_context_data("method", "POST")                  â”‚
â”‚  â€¢ set_context_data("path", "/v1/headers")            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Service Layer                           â”‚
â”‚  â€¢ get_log_context() â†’ includes request_id             â”‚
â”‚  â€¢ set_context_data("service", "HeaderService")       â”‚
â”‚  â€¢ logger.info(..., extra=get_log_context())          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Repository Layer                           â”‚
â”‚  â€¢ get_log_context() â†’ includes request_id             â”‚
â”‚  â€¢ set_context_data("repository", "HeaderRepo")       â”‚
â”‚  â€¢ logger.debug(..., extra=get_log_context())         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Database Layer                            â”‚
â”‚  â€¢ get_log_context() â†’ includes request_id             â”‚
â”‚  â€¢ logger.debug(..., extra=get_log_context())         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ‰€æœ‰å±‚çº§çš„æ—¥å¿—éƒ½åŒ…å«ç›¸åŒçš„ request_idï¼
```

## ğŸ” ä½¿ç”¨åœºæ™¯

### 1. è°ƒè¯•é—®é¢˜

```bash
# æŸ¥æ‰¾ç‰¹å®šè¯·æ±‚çš„æ‰€æœ‰æ—¥å¿—
grep "REQ-abc123" logs/app.log

# è¾“å‡ºå®Œæ•´çš„è¯·æ±‚é“¾è·¯
```

### 2. æ€§èƒ½åˆ†æ

```bash
# æŸ¥çœ‹è¯·æ±‚çš„å¤„ç†æ—¶é—´
cat logs/app.log | jq 'select(.request_id == "REQ-abc123" and .duration)'
```

### 3. é”™è¯¯è¿½è¸ª

```bash
# æŸ¥æ‰¾å¯¼è‡´é”™è¯¯çš„å®Œæ•´è¯·æ±‚é“¾è·¯
grep "REQ-error-999" logs/app.log
```

### 4. ç›‘æ§å’Œå‘Šè­¦

- æŒ‰ request_id èšåˆæ—¥å¿—
- è¿½è¸ªæ…¢è¯·æ±‚
- åˆ†æé”™è¯¯ç‡

## ğŸ“ ä»£ç ç¤ºä¾‹

### åœ¨ä»»ä½•å±‚çº§ä½¿ç”¨

```python
from morado.common.logger import get_logger
from morado.common.logger.context import get_log_context, set_context_data

logger = get_logger(__name__)

def my_function():
    # æ·»åŠ é¢å¤–çš„ä¸Šä¸‹æ–‡
    set_context_data("operation", "my_operation")
    
    # è®°å½•æ—¥å¿— - è‡ªåŠ¨åŒ…å« request_id å’Œæ‰€æœ‰ä¸Šä¸‹æ–‡
    logger.info(
        "Doing something",
        extra={
            **get_log_context(),  # åŒ…å« request_id, method, path ç­‰
            "additional_data": "value",
        },
    )
```

### é”™è¯¯å¤„ç†

```python
try:
    risky_operation()
except Exception as e:
    logger.exception(
        "Operation failed",
        extra={
            **get_log_context(),  # é”™è¯¯æ—¥å¿—ä¹ŸåŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡
            "error": str(e),
        },
    )
    raise
```

## âœ… æµ‹è¯•éªŒè¯

### è¿è¡Œæ¼”ç¤º

```bash
cd backend
uv run python scripts/demo_request_tracing.py
```

### æµ‹è¯•ç»“æœ

```
âœ“ Request ID åœ¨æ•´ä¸ªè°ƒç”¨é“¾ä¸­ä¿æŒä¸€è‡´
âœ“ ä¸Šä¸‹æ–‡æ•°æ®æ­£ç¡®ä¼ æ’­
âœ“ å¤šä¸ªå¹¶å‘è¯·æ±‚äº’ä¸å¹²æ‰°
âœ“ é”™è¯¯æƒ…å†µä¸‹ä¸Šä¸‹æ–‡å®Œæ•´ä¿ç•™
âœ“ æ€§èƒ½å¼€é”€æœ€å°
```

## ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®

### å¯é€‰çš„å¢å¼º

1. **åˆ†å¸ƒå¼è¿½è¸ª**
   - é›†æˆ OpenTelemetry
   - è·¨æœåŠ¡è¿½è¸ª
   - Span å’Œ Trace æ”¯æŒ

2. **æ—¥å¿—èšåˆ**
   - é›†æˆ ELK Stack
   - é›†æˆ Grafana Loki
   - é›†æˆ Datadog

3. **æ€§èƒ½ç›‘æ§**
   - æ·»åŠ æ€§èƒ½æŒ‡æ ‡
   - æ…¢è¯·æ±‚å‘Šè­¦
   - èµ„æºä½¿ç”¨ç›‘æ§

4. **æ›´å¤šä¸Šä¸‹æ–‡**
   - ç”¨æˆ·ä¿¡æ¯
   - ä¼šè¯ä¿¡æ¯
   - ä¸šåŠ¡ä¸Šä¸‹æ–‡

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å…¨é“¾è·¯è¯·æ±‚è·Ÿè¸ªæŒ‡å—](./REQUEST_TRACING_GUIDE.md) - è¯¦ç»†ä½¿ç”¨æŒ‡å—
- [æ—¥å¿—ç³»ç»Ÿä½¿ç”¨æŒ‡å—](./LOGGING_GUIDE.md) - æ—¥å¿—ç³»ç»Ÿå®Œæ•´æ–‡æ¡£
- [æ—¥å¿—å¿«é€Ÿå‚è€ƒ](./LOGGING_QUICK_REFERENCE.md) - å¿«é€ŸæŸ¥è¯¢æ‰‹å†Œ
- [æ—¥å¿—å®æ–½æ€»ç»“](./LOGGING_IMPLEMENTATION_SUMMARY.md) - å®æ–½ç»†èŠ‚

## ğŸ‰ æ€»ç»“

Morado ç°åœ¨æ‹¥æœ‰å®Œæ•´çš„å…¨é“¾è·¯è¯·æ±‚è·Ÿè¸ªç³»ç»Ÿï¼š

1. âœ… **è‡ªåŠ¨åŒ–** - æ— éœ€æ‰‹åŠ¨ä¼ é€’ Request ID
2. âœ… **å®Œæ•´æ€§** - è¦†ç›–æ‰€æœ‰å±‚çº§
3. âœ… **æ˜“ç”¨æ€§** - ç®€å•çš„ API
4. âœ… **é«˜æ€§èƒ½** - åŸºäº Python å†…ç½®æœºåˆ¶
5. âœ… **å¯è¿½æº¯** - è½»æ¾è¿½è¸ªè¯·æ±‚ç”Ÿå‘½å‘¨æœŸ

ä» HTTP è¯·æ±‚è¿›å…¥åˆ°æ•°æ®åº“æ“ä½œï¼Œæ‰€æœ‰æ—¥å¿—éƒ½ä½¿ç”¨åŒä¸€ä¸ª Request IDï¼Œå®ç°äº†çœŸæ­£çš„å…¨é“¾è·¯è·Ÿè¸ªï¼

---

**å®æ–½æ—¥æœŸï¼š** 2024-12-23  
**æµ‹è¯•çŠ¶æ€ï¼š** âœ… é€šè¿‡  
**ç”Ÿäº§å°±ç»ªï¼š** âœ… æ˜¯
