# Morado 系统架构设计

## 概述

Morado 是一个现代化的自动化测试平台，采用前后端分离的 BS 架构设计。本文档详细描述系统的整体架构、技术栈选型、四层架构设计以及各组件之间的关系。

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户层 (User Layer)                             │
│                         浏览器 / API 客户端 / CLI                            │
└─────────────────────────────────────┬───────────────────────────────────────┘
                                      │ HTTP/HTTPS
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            网关层 (Gateway Layer)                            │
│                              Nginx 反向代理                                  │
│                    静态资源服务 / API 路由 / 负载均衡                         │
└───────────────┬─────────────────────────────────────────┬───────────────────┘
                │                                         │
                ▼                                         ▼
┌───────────────────────────────┐       ┌───────────────────────────────────┐
│      前端应用 (Frontend)       │       │        后端服务 (Backend)          │
│                               │       │                                   │
│  ┌─────────────────────────┐  │       │  ┌─────────────────────────────┐  │
│  │      Vue 3 SPA          │  │       │  │      Litestar API           │  │
│  │  ┌─────────────────┐    │  │       │  │  ┌─────────────────────┐    │  │
│  │  │   Components    │    │  │       │  │  │    API Routes       │    │  │
│  │  ├─────────────────┤    │  │       │  │  ├─────────────────────┤    │  │
│  │  │     Views       │    │  │       │  │  │    Services         │    │  │
│  │  ├─────────────────┤    │  │       │  │  ├─────────────────────┤    │  │
│  │  │   Pinia Store   │    │  │       │  │  │   Repositories      │    │  │
│  │  ├─────────────────┤    │  │       │  │  ├─────────────────────┤    │  │
│  │  │   Vue Router    │    │  │       │  │  │     Models          │    │  │
│  │  └─────────────────┘    │  │       │  │  └─────────────────────┘    │  │
│  └─────────────────────────┘  │       │  └─────────────────────────────┘  │
└───────────────────────────────┘       └───────────────┬───────────────────┘
                                                        │
                                                        ▼
                              ┌─────────────────────────────────────────────┐
                              │              数据层 (Data Layer)             │
                              │  ┌─────────────────┐  ┌─────────────────┐   │
                              │  │   PostgreSQL    │  │     Redis       │   │
                              │  │   (主数据库)     │  │    (缓存)       │   │
                              │  └─────────────────┘  └─────────────────┘   │
                              └─────────────────────────────────────────────┘
```

## 技术栈

### 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Python | 3.13+ | 编程语言 |
| Litestar | 2.19+ | Web 框架 |
| SQLAlchemy | 2.0+ | ORM |
| Pydantic | 2.12+ | 数据验证 |
| Alembic | 1.17+ | 数据库迁移 |
| PostgreSQL | 15+ | 关系型数据库 |
| Redis | 7+ | 缓存和消息队列 |
| Uvicorn | 0.38+ | ASGI 服务器 |
| Structlog | 25+ | 结构化日志 |

### 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Vue | 3.5+ | 前端框架 |
| Vite | 8.0+ | 构建工具 |
| TypeScript | 5.9+ | 类型安全 |
| Tailwind CSS | 4.1+ | 样式框架 |
| Pinia | 3.0+ | 状态管理 |
| Vue Router | 4.6+ | 路由管理 |
| Axios | 1.13+ | HTTP 客户端 |
| Headless UI | 1.7+ | 无样式组件 |

### 开发工具

| 工具 | 用途 |
|------|------|
| Ruff | Python 代码检查和格式化 |
| ty | Python 类型检查 |
| Biome | 前端代码检查和格式化 |
| pytest | Python 测试框架 |
| Vitest | 前端测试框架 |
| Hypothesis | 属性测试 |

## 后端分层架构

后端采用经典的分层架构设计，各层职责明确：

```
┌─────────────────────────────────────────────────────────────┐
│                    API Layer (api/)                          │
│              路由定义、请求验证、响应格式化                    │
│                                                              │
│  - 接收 HTTP 请求                                            │
│  - 参数验证和转换                                            │
│  - 调用 Service 层                                           │
│  - 返回标准化响应                                            │
└────────────────────────────┬────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────┐
│                 Service Layer (services/)                    │
│                    业务逻辑、事务管理                         │
│                                                              │
│  - 实现业务逻辑                                              │
│  - 事务边界控制                                              │
│  - 调用 Repository 层                                        │
│  - 跨实体操作协调                                            │
└────────────────────────────┬────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────┐
│              Repository Layer (repositories/)                │
│                   数据访问、查询封装                          │
│                                                              │
│  - 封装数据库操作                                            │
│  - 提供 CRUD 接口                                            │
│  - 复杂查询封装                                              │
│  - 数据库无关抽象                                            │
└────────────────────────────┬────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────┐
│                  Model Layer (models/)                       │
│                 SQLAlchemy ORM 模型定义                       │
│                                                              │
│  - 数据库表映射                                              │
│  - 关系定义                                                  │
│  - 字段约束                                                  │
└─────────────────────────────────────────────────────────────┘
```

## 四层架构设计

Morado 测试平台的核心是独特的四层架构设计，从底层的接口定义到顶层的测试用例，每一层都有明确的职责和可复用性。

### 四层架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        第四层：测试用例层 (Test Case)                         │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  TestCase                                                             │   │
│  │  - 用户直接操作的测试单元                                              │   │
│  │  - 可以引用脚本或联合组件                                              │   │
│  │  - 支持执行顺序配置和参数覆盖                                          │   │
│  │  - 关联: TestCaseScript, TestCaseComponent                            │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────┬────────────────────────────────────────┘
                                     │ 引用
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                       第三层：联合组件层 (Component)                          │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  TestComponent                                                        │   │
│  │  - 多个脚本的组合                                                      │   │
│  │  - 可以嵌套引用其他组件 (parent_component_id)                          │   │
│  │  - 支持独立调试执行                                                    │   │
│  │  - 关联: ComponentScript                                              │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────┬────────────────────────────────────────┘
                                     │ 引用
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         第二层：脚本层 (Script)                              │
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  TestScript                                                           │   │
│  │  - 接口的实际实现和调试层                                              │   │
│  │  - 引用 API 定义并添加测试逻辑                                         │   │
│  │  - 支持前置/主/后置脚本                                                │   │
│  │  - 支持断言和验证器配置                                                │   │
│  │  - 关联: ScriptParameter                                              │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────┬────────────────────────────────────────┘
                                     │ 引用
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      第一层：接口定义层 (API Definition)                      │
│                                                                              │
│  ┌────────────┐      ┌────────────┐      ┌─────────────────────────────┐   │
│  │   Header   │─────▶│    Body    │─────▶│      API Definition         │   │
│  │   组件     │      │    组件    │      │   (引用 Header + Body)       │   │
│  │            │      │            │      │   或 (引用 Header + 内联)    │   │
│  │ - 认证头   │      │ - 请求体   │      │                             │   │
│  │ - 通用头   │      │ - 响应体   │      │ - HTTP 方法                  │   │
│  │ - 项目头   │      │ - Schema   │      │ - 路径                       │   │
│  └────────────┘      └────────────┘      │ - 参数                       │   │
│                                          └─────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 数据流图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              测试执行数据流                                   │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────────────────────┐
                    │         运行时参数               │
                    │    (Runtime Parameters)         │
                    │         最高优先级              │
                    └───────────────┬─────────────────┘
                                    │
                    ┌───────────────▼─────────────────┐
                    │       测试用例数据               │
                    │    (Test Case Data)             │
                    └───────────────┬─────────────────┘
                                    │
                    ┌───────────────▼─────────────────┐
                    │      组件共享变量                │
                    │  (Component Shared Variables)   │
                    └───────────────┬─────────────────┘
                                    │
                    ┌───────────────▼─────────────────┐
                    │        脚本变量                  │
                    │   (Script Variables)            │
                    └───────────────┬─────────────────┘
                                    │
                    ┌───────────────▼─────────────────┐
                    │     脚本参数默认值               │
                    │ (Script Parameter Defaults)     │
                    └───────────────┬─────────────────┘
                                    │
                    ┌───────────────▼─────────────────┐
                    │        环境配置                  │
                    │   (Environment Config)          │
                    │         最低优先级              │
                    └─────────────────────────────────┘
```

### Header 和 Body 复用机制

Header 和 Body 组件是独立管理的可复用单元：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Header 复用示例                                    │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────┐
    │   认证 Header       │
    │ Authorization:      │
    │ Bearer ${token}     │
    └──────────┬──────────┘
               │
    ┌──────────┼──────────┬──────────────────┐
    │          │          │                  │
    ▼          ▼          ▼                  ▼
┌────────┐ ┌────────┐ ┌────────┐      ┌────────┐
│ API 1  │ │ API 2  │ │ API 3  │ ...  │ API N  │
│获取用户│ │创建订单│ │查询报告│      │其他API │
└────────┘ └────────┘ └────────┘      └────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                            Body 复用示例                                     │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────────┐      ┌─────────────────────┐
    │   用户信息 Body     │      │   订单信息 Body     │
    │ {name, age, email}  │      │ {items, total}      │
    └──────────┬──────────┘      └──────────┬──────────┘
               │                            │
    ┌──────────┼──────────┐      ┌──────────┼──────────┐
    │          │          │      │          │          │
    ▼          ▼          ▼      ▼          ▼          ▼
┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐
│创建用户│ │更新用户│ │查询用户│ │创建订单│ │更新订单│
└────────┘ └────────┘ └────────┘ └────────┘ └────────┘
```

### 组件嵌套机制

组件支持嵌套引用，实现复杂测试流程的组合：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           组件嵌套示例                                       │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  TestComponent: "完整业务流程"                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  Component 1: "用户管理流程"                                           │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │  Script 1: 创建用户                                              │  │  │
│  │  │  Script 2: 查询用户                                              │  │  │
│  │  │  Script 3: 更新用户                                              │  │  │
│  │  │  Script 4: 删除用户                                              │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  Component 2: "订单管理流程"                                           │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │  Script 5: 创建订单                                              │  │  │
│  │  │  Script 6: 查询订单                                              │  │  │
│  │  │  Script 7: 取消订单                                              │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  Script 8: 生成综合报告                                               │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 数据库设计

### 实体关系图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据库实体关系                                   │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────┐     ┌──────────────┐     ┌──────────────────────┐
│   headers    │     │    bodies    │     │   api_definitions    │
├──────────────┤     ├──────────────┤     ├──────────────────────┤
│ id           │◄────│ id           │◄────│ id                   │
│ name         │     │ name         │     │ name                 │
│ headers      │     │ body_type    │     │ method               │
│ is_global    │     │ body_schema  │     │ path                 │
│ project_id   │     │ example_data │     │ header_id ──────────►│
└──────────────┘     └──────────────┘     │ request_body_id ────►│
                                          │ response_body_id ───►│
                                          │ inline_request_body  │
                                          │ inline_response_body │
                                          └──────────┬───────────┘
                                                     │
                                                     ▼
┌──────────────────────┐     ┌──────────────────────────────────┐
│  script_parameters   │     │          test_scripts            │
├──────────────────────┤     ├──────────────────────────────────┤
│ id                   │◄────│ id                               │
│ script_id ──────────►│     │ name                             │
│ name                 │     │ api_definition_id ──────────────►│
│ param_type           │     │ script_content                   │
│ default_value        │     │ assertions                       │
└──────────────────────┘     │ script_type                      │
                             └──────────────┬───────────────────┘
                                            │
              ┌─────────────────────────────┼─────────────────────────────┐
              │                             │                             │
              ▼                             ▼                             ▼
┌──────────────────────┐     ┌──────────────────────┐     ┌──────────────────────┐
│   test_components    │     │   component_scripts  │     │   test_case_scripts  │
├──────────────────────┤     ├──────────────────────┤     ├──────────────────────┤
│ id                   │◄────│ id                   │     │ id                   │
│ name                 │     │ component_id ───────►│     │ test_case_id ───────►│
│ parent_component_id ─┼──┐  │ script_id ──────────►│     │ script_id ──────────►│
│ execution_order      │  │  │ execution_order      │     │ execution_order      │
└──────────────────────┘  │  │ script_parameters    │     │ script_parameters    │
         ▲                │  └──────────────────────┘     └──────────────────────┘
         │                │
         └────────────────┘ (自引用，支持嵌套)

┌──────────────────────┐     ┌──────────────────────────────────┐
│ test_case_components │     │          test_cases              │
├──────────────────────┤     ├──────────────────────────────────┤
│ id                   │◄────│ id                               │
│ test_case_id ───────►│     │ name                             │
│ component_id ───────►│     │ description                      │
│ execution_order      │     │ priority                         │
│ component_parameters │     │ status                           │
└──────────────────────┘     └──────────────────────────────────┘
```

## 部署架构

### Docker 部署

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Docker Compose 部署                                │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              Docker Network                                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐  │
│  │    frontend     │  │     backend     │  │         postgres            │  │
│  │   (Nginx)       │  │   (Uvicorn)     │  │       (PostgreSQL)          │  │
│  │                 │  │                 │  │                             │  │
│  │  Port: 80/443   │  │   Port: 8000    │  │       Port: 5432            │  │
│  └────────┬────────┘  └────────┬────────┘  └─────────────────────────────┘  │
│           │                    │                                            │
│           │                    │           ┌─────────────────────────────┐  │
│           │                    │           │          redis              │  │
│           │                    │           │         (Redis)             │  │
│           │                    │           │                             │  │
│           │                    │           │       Port: 6379            │  │
│           │                    │           └─────────────────────────────┘  │
└───────────┼────────────────────┼────────────────────────────────────────────┘
            │                    │
            ▼                    ▼
    ┌───────────────────────────────────────┐
    │           Host Machine                │
    │      Port 80 → frontend:80            │
    │      Port 8000 → backend:8000         │
    └───────────────────────────────────────┘
```

### Kubernetes 部署

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Kubernetes 集群                                     │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                           Ingress                                      │  │
│  │                    (路由 + TLS 终止)                                   │  │
│  └───────────────────────────────┬───────────────────────────────────────┘  │
│                                  │                                          │
│         ┌────────────────────────┼────────────────────────┐                 │
│         │                        │                        │                 │
│         ▼                        ▼                        ▼                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐  │
│  │ frontend-svc    │  │  backend-svc    │  │      postgres-svc           │  │
│  │  (ClusterIP)    │  │  (ClusterIP)    │  │      (ClusterIP)            │  │
│  └────────┬────────┘  └────────┬────────┘  └─────────────────────────────┘  │
│           │                    │                                            │
│           ▼                    ▼                                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐  │
│  │ frontend-deploy │  │ backend-deploy  │  │     postgres-statefulset    │  │
│  │  (Deployment)   │  │  (Deployment)   │  │      (StatefulSet)          │  │
│  │   replicas: 2   │  │   replicas: 3   │  │       replicas: 1           │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 安全设计

### 认证和授权

- JWT Token 认证
- 基于角色的访问控制 (RBAC)
- API 密钥支持

### 数据安全

- 敏感数据加密存储
- HTTPS 传输加密
- SQL 注入防护
- XSS 防护

## 性能优化

### 后端优化

- 数据库连接池
- Redis 缓存
- 异步处理
- 分页查询

### 前端优化

- 路由懒加载
- 组件按需加载
- 静态资源压缩
- CDN 加速

## 监控和日志

### 日志系统

- 结构化日志 (Structlog)
- 请求追踪 (Request ID)
- 日志级别配置
- 日志聚合

### 监控指标

- API 响应时间
- 错误率统计
- 资源使用率
- 业务指标

## 相关文档

- [四层架构详细设计](four-layer-architecture.md)
- [四层架构使用指南](four-layer-guide.md)
- [数据管理与执行机制](data-management-and-execution.md)
- [开发指南](development.md)
- [部署指南](deployment.md)
